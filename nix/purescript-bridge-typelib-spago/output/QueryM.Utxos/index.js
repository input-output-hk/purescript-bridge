// Generated by purs version 0.14.5
"use strict";
var Address = require("../Address/index.js");
var Control_Applicative = require("../Control.Applicative/index.js");
var Control_Bind = require("../Control.Bind/index.js");
var Control_Monad_Logger_Trans = require("../Control.Monad.Logger.Trans/index.js");
var Control_Monad_Reader_Class = require("../Control.Monad.Reader.Class/index.js");
var Control_Monad_Reader_Trans = require("../Control.Monad.Reader.Trans/index.js");
var Data_Bifunctor = require("../Data.Bifunctor/index.js");
var Data_Bitraversable = require("../Data.Bitraversable/index.js");
var Data_Foldable = require("../Data.Foldable/index.js");
var Data_Functor = require("../Data.Functor/index.js");
var Data_Map_Internal = require("../Data.Map.Internal/index.js");
var Data_Maybe = require("../Data.Maybe/index.js");
var Data_Newtype = require("../Data.Newtype/index.js");
var Data_Traversable = require("../Data.Traversable/index.js");
var Data_Unfoldable = require("../Data.Unfoldable/index.js");
var Effect_Aff = require("../Effect.Aff/index.js");
var Helpers = require("../Helpers/index.js");
var QueryM = require("../QueryM/index.js");
var QueryM_Ogmios = require("../QueryM.Ogmios/index.js");
var TxOutput = require("../TxOutput/index.js");
var Types_Transaction = require("../Types.Transaction/index.js");
var Types_UsedTxOuts = require("../Types.UsedTxOuts/index.js");
var withTxRefsCache = function (f) {
    return Control_Monad_Reader_Trans.withReaderT(function (v) {
        return v.usedTxOuts;
    })(f);
};
var utxosAt = function (addr) {
    var allUtxosAt = (function () {
        var utxosAt$prime = function (addr$prime) {
            return QueryM.mkOgmiosRequest(QueryM_Ogmios.queryUtxosAtCall)(function (v) {
                return v.utxo;
            })(addr$prime);
        };
        var convertUtxos = function (v) {
            var out$prime = Data_Functor.mapFlipped(Data_Functor.functorArray)(Data_Map_Internal.toUnfoldable(Data_Unfoldable.unfoldableArray)(v))(Data_Bifunctor.bimap(Data_Bifunctor.bifunctorTuple)(TxOutput.txOutRefToTransactionInput)(TxOutput.ogmiosTxOutToTransactionOutput));
            var out = Data_Traversable.sequence(Data_Traversable.traversableArray)(Data_Maybe.applicativeMaybe)(Data_Functor.mapFlipped(Data_Functor.functorArray)(out$prime)(Data_Bitraversable.bisequence(Data_Bitraversable.bitraversableTuple)(Data_Maybe.applicativeMaybe)));
            return Data_Functor.map(Data_Maybe.functorMaybe)((function () {
                var $12 = Data_Newtype.wrap();
                var $13 = Data_Map_Internal.fromFoldable(Types_Transaction.ordTransactionInput)(Data_Foldable.foldableArray);
                return function ($14) {
                    return $12($13($14));
                };
            })())(out);
        };
        var getUtxos = function (address) {
            return Data_Functor.map(Control_Monad_Reader_Trans.functorReaderT(Control_Monad_Logger_Trans.functorLoggerT(Effect_Aff.functorAff)))(convertUtxos)(utxosAt$prime(address));
        };
        return function ($15) {
            return getUtxos(Address.addressToOgmiosAddress($15));
        };
    })();
    var namiUtxosAt = function (address) {
        return Control_Bind.bind(Control_Monad_Reader_Trans.bindReaderT(Control_Monad_Logger_Trans.bindLoggerT(Effect_Aff.monadAff)))(allUtxosAt(address))(function (utxos$prime) {
            return Control_Bind.bind(Control_Monad_Reader_Trans.bindReaderT(Control_Monad_Logger_Trans.bindLoggerT(Effect_Aff.monadAff)))(QueryM.getWalletCollateral)(function (collateral$prime) {
                return Control_Applicative.pure(Control_Monad_Reader_Trans.applicativeReaderT(Control_Monad_Logger_Trans.applicativeLoggerT(Effect_Aff.monadAff)))(Control_Bind.bind(Data_Maybe.bindMaybe)(Data_Functor.map(Data_Maybe.functorMaybe)(Data_Newtype.unwrap())(utxos$prime))(function (utxos) {
                    return Control_Bind.bind(Data_Maybe.bindMaybe)(Data_Functor.map(Data_Maybe.functorMaybe)(Data_Newtype.unwrap())(collateral$prime))(function (collateral) {
                        return Control_Applicative.pure(Data_Maybe.applicativeMaybe)(Data_Newtype.wrap()(Data_Map_Internal["delete"](Types_Transaction.ordTransactionInput)(collateral.input)(utxos)));
                    });
                }));
            });
        });
    };
    var utxosAtByWallet = function (address) {
        return function (v) {
            return namiUtxosAt(address);
        };
    };
    return Control_Bind.bind(Control_Monad_Reader_Trans.bindReaderT(Control_Monad_Logger_Trans.bindLoggerT(Effect_Aff.monadAff)))(Control_Monad_Reader_Class.asks(Control_Monad_Reader_Trans.monadAskReaderT(Control_Monad_Logger_Trans.monadLoggerT(Effect_Aff.monadAff)))(function (v) {
        return v.wallet;
    }))(Data_Maybe.maybe(allUtxosAt(addr))(utxosAtByWallet(addr)));
};
var filterUnusedUtxos = function (v) {
    return withTxRefsCache(Data_Functor.map(Control_Monad_Reader_Trans.functorReaderT(Control_Monad_Logger_Trans.functorLoggerT(Effect_Aff.functorAff)))(Types_Transaction.UtxoM)(Helpers.filterMapWithKeyM(Types_Transaction.ordTransactionInput)(Control_Monad_Reader_Trans.monadReaderT(Control_Monad_Logger_Trans.monadLoggerT(Effect_Aff.monadAff)))(function (k) {
        return function (v1) {
            return Types_UsedTxOuts.isTxOutRefUsed(Control_Monad_Reader_Trans.monadAskReaderT(Control_Monad_Logger_Trans.monadLoggerT(Effect_Aff.monadAff)))(Control_Monad_Reader_Trans.monadEffectReader(Control_Monad_Logger_Trans.monadEffectLoggerT(Effect_Aff.monadEffectAff)))(Data_Newtype.unwrap()(k));
        };
    })(v)));
};
module.exports = {
    filterUnusedUtxos: filterUnusedUtxos,
    utxosAt: utxosAt
};
